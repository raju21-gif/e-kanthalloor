<!DOCTYPE html>
<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>e-Panchayat National Governance Portal</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&amp;display=swap"
        rel="stylesheet" />
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#065f46",
                        "primary-light": "#ecfdf5",
                        "accent": "#b45309",
                        "background-light": "#fcfdfc",
                        "background-dark": "#061512",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        @layer base {
            body {
                font-family: 'Manrope', sans-serif;
                @apply bg-background-light text-slate-900;
            }
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
        }

        .section-gradient {
            background: linear-gradient(135deg, #065f46 0%, #064e3b 100%);
        }
        
        /* Modal Transitions */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 300ms ease-out, transform 300ms ease-out; }
        .modal-exit { opacity: 1; transform: scale(1); }
        .modal-exit-active { opacity: 0; transform: scale(0.95); transition: opacity 200ms ease-in, transform 200ms ease-in; }
    </style>
</head>

<body class="dark:bg-background-dark dark:text-white transition-colors duration-200">
    <header
        class="sticky top-0 z-50 w-full border-b border-emerald-100 dark:border-emerald-900/30 bg-white/90 dark:bg-background-dark/90 backdrop-blur-md">
        <div class="max-w-[1280px] mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="bg-primary p-2 rounded-xl text-white shadow-lg shadow-emerald-900/20">
                    <span class="material-symbols-outlined text-3xl">account_balance</span>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight text-primary dark:text-emerald-400 leading-none">
                        e-Panchayat</h1>
                    <p
                        class="text-[10px] font-bold uppercase tracking-widest text-emerald-700/70 dark:text-emerald-500/70 mt-1">
                        Digital Local Governance</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <button
                    class="hidden sm:flex items-center gap-2 px-4 py-2 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg text-xs font-bold text-primary dark:text-emerald-400 border border-emerald-100 dark:border-emerald-800/50">
                    <span class="material-symbols-outlined text-lg">language</span>
                    <span>Select Language</span>
                </button>
                <!-- Guest Nav -->
                <div id="guest-nav">
                    <button onclick="openAuthModal('login')"
                        class="bg-primary text-white px-6 py-2.5 rounded-xl text-sm font-bold hover:bg-emerald-700 shadow-xl shadow-emerald-900/20 transition-all hover:-translate-y-0.5 active:translate-y-0">
                        Portal Login
                    </button>
                </div>

                <!-- User Nav (Hidden by default) -->
                <div id="user-nav" class="hidden items-center gap-4">
                    <button onclick="goToDashboard()"
                        class="hidden md:flex items-center gap-2 px-4 py-2 bg-emerald-50 text-primary font-bold rounded-xl border border-emerald-100 hover:bg-emerald-100 transition-colors text-xs uppercase tracking-wider">
                        <span class="material-symbols-outlined text-lg">grid_view</span> Dashboard
                    </button>

                    <div class="flex items-center gap-3 pl-4 border-l border-slate-200 cursor-pointer group relative"
                        onclick="toggleProfileMenu()">
                        <div class="text-right hidden sm:block">
                            <p class="text-sm font-bold text-slate-700 group-hover:text-primary transition-colors"
                                id="nav-user-name">User</p>
                            <p class="text-[9px] text-emerald-600 font-bold uppercase tracking-widest"
                                id="nav-user-role">Citizen</p>
                        </div>
                        <div id="nav-user-avatar"
                            class="size-10 rounded-full bg-emerald-100 text-emerald-700 border-2 border-emerald-200 flex items-center justify-center font-bold text-lg shadow-sm group-hover:scale-105 transition-transform">
                            U
                        </div>

                        <!-- Dropdown -->
                        <div id="profile-dropdown"
                            class="hidden absolute top-full right-0 mt-3 w-48 bg-white border border-slate-100 rounded-2xl shadow-xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                            <a href="#" onclick="goToDashboard()"
                                class="block px-5 py-3 text-sm font-bold text-slate-600 hover:bg-emerald-50 hover:text-emerald-700">
                                Dashboard
                            </a>
                            <div class="h-px bg-slate-100"></div>
                            <a href="#" onclick="logout()"
                                class="block px-5 py-3 text-sm font-bold text-red-500 hover:bg-red-50">
                                Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <main class="max-w-[1280px] mx-auto px-6 py-10">
        <section class="relative rounded-[2.5rem] overflow-hidden mb-16 bg-emerald-900 text-white shadow-2xl">
            <div class="absolute inset-0 opacity-20 pointer-events-none"
                style="background-image: url('https://lh3.googleusercontent.com/aida-public/AB6AXuByyBO84AaTXWUQGgdYr4wMN_eJci07SdT5oSmakZbBMDcoji3eGlJwZ6IUIClug9etei47H4OtzF5X8_RfnXbPrkvfDg-Tlop8ueQtIiLsvXQSH-4uLzeLmRlJU4g-Jm_TSzMJixE2kbkyS_bn8g8sJsj3OKMKHoMLW3iDoaHKiERIeAD71ZZctYYObTi7ssdHRgCLUi8us474S8oDm0lUFBm_v9C-DS3muBBdn135HD0AaUgh-QaphzigGm-THraEuX-Kr0_jFoqi');">
            </div>
            <div class="relative z-10 px-8 py-24 text-center max-w-4xl mx-auto">
                <div
                    class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-emerald-800/50 border border-emerald-700/50 text-emerald-200 text-xs font-bold mb-8">
                    <span class="relative flex h-2 w-2">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Empowering Local Governance Digitally
                </div>
                <h2 class="text-4xl md:text-6xl font-black leading-[1.1] mb-8">
                    Unified Digital Services for Rural Governance
                </h2>
                <p class="text-lg text-emerald-100/80 mb-12 max-w-2xl mx-auto font-medium">
                    Access welfare schemes, infrastructure projects, and essential citizen services through our
                    standardized e-governance infrastructure.
                </p>
                <div class="relative max-w-3xl mx-auto">
                    <div class="absolute -inset-2 bg-emerald-400/20 rounded-[2rem] blur-xl"></div>
                    <!-- Search Bar Removed -->

                    <div class="flex flex-wrap justify-center gap-4 mt-6">
                        <span class="text-xs font-bold text-emerald-100/60 uppercase tracking-widest">Trending:</span>
                        <a class="text-xs font-bold text-emerald-200 hover:underline" href="#">Welfare Schemes</a>
                        <a class="text-xs font-bold text-emerald-200 hover:underline" href="#">Land Records</a>
                        <a class="text-xs font-bold text-emerald-200 hover:underline" href="#">Birth Certificate</a>
                    </div>
                </div>
            </div>
        </section>
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <div class="lg:col-span-8">
                <div class="flex items-center justify-between mb-8 px-2">
                    <div>
                        <h3 class="text-3xl font-black tracking-tight text-slate-900 dark:text-white">National Service
                            Directory</h3>
                        <p class="text-emerald-700/60 dark:text-emerald-500/60 text-sm font-bold">Standardized
                            governance categories for all local bodies</p>
                    </div>
                    <a class="group text-sm font-black text-primary flex items-center gap-2 hover:gap-3 transition-all"
                        href="#">
                        All Services <span class="material-symbols-outlined text-lg">arrow_right_alt</span>
                    </a>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div
                        class="group p-8 bg-white dark:bg-slate-900 border-2 border-emerald-50 dark:border-emerald-900/20 rounded-[2rem] hover:border-primary transition-all hover:shadow-2xl hover:shadow-emerald-900/5 cursor-pointer">
                        <div class="flex items-start justify-between mb-6">
                            <div
                                class="size-14 rounded-2xl bg-emerald-100 dark:bg-emerald-900/30 text-primary dark:text-emerald-400 flex items-center justify-center shadow-inner">
                                <span class="material-symbols-outlined text-3xl">agriculture</span>
                            </div>
                            <span
                                class="text-[10px] font-black uppercase tracking-widest text-white bg-emerald-600 px-3 py-1 rounded-full">Primary
                                Sector</span>
                        </div>
                        <h4 class="text-xl font-extrabold mb-3 text-slate-900 dark:text-white">Agriculture &amp; Farming
                        </h4>
                        <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed font-medium">
                            Access agricultural subsidies, crop insurance schemes, irrigation support, and modern
                            farming
                            equipment rentals.
                        </p>
                    </div>
                    <div
                        class="group p-8 bg-white dark:bg-slate-900 border-2 border-emerald-50 dark:border-emerald-900/20 rounded-[2rem] hover:border-primary transition-all hover:shadow-2xl hover:shadow-emerald-900/5 cursor-pointer">
                        <div class="flex items-start justify-between mb-6">
                            <div
                                class="size-14 rounded-2xl bg-emerald-100 dark:bg-emerald-900/30 text-primary dark:text-emerald-400 flex items-center justify-center shadow-inner">
                                <span class="material-symbols-outlined text-3xl">groups</span>
                            </div>
                        </div>
                        <h4 class="text-xl font-extrabold mb-3 text-slate-900 dark:text-white">Social Welfare</h4>
                        <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed font-medium">
                            Direct benefit transfers, pension management, women and child development programs, and
                            community support initiatives.
                        </p>
                    </div>
                    <div
                        class="group p-8 bg-white dark:bg-slate-900 border-2 border-emerald-50 dark:border-emerald-900/20 rounded-[2rem] hover:border-primary transition-all hover:shadow-2xl hover:shadow-emerald-900/5 cursor-pointer">
                        <div class="flex items-start justify-between mb-6">
                            <div
                                class="size-14 rounded-2xl bg-emerald-100 dark:bg-emerald-900/30 text-primary dark:text-emerald-400 flex items-center justify-center shadow-inner">
                                <span class="material-symbols-outlined text-3xl">engineering</span>
                            </div>
                        </div>
                        <h4 class="text-xl font-extrabold mb-3 text-slate-900 dark:text-white">Infrastructure &amp;
                            Public Works</h4>
                        <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed font-medium">
                            Track local development projects, apply for building permits, and report issues regarding
                            roads, water, or street lighting.
                        </p>
                    </div>
                    <div
                        class="group p-8 bg-white dark:bg-slate-900 border-2 border-emerald-50 dark:border-emerald-900/20 rounded-[2rem] hover:border-primary transition-all hover:shadow-2xl hover:shadow-emerald-900/5 cursor-pointer">
                        <div class="flex items-start justify-between mb-6">
                            <div
                                class="size-14 rounded-2xl bg-emerald-100 dark:bg-emerald-900/30 text-primary dark:text-emerald-400 flex items-center justify-center shadow-inner">
                                <span class="material-symbols-outlined text-3xl">receipt_long</span>
                            </div>
                        </div>
                        <h4 class="text-xl font-extrabold mb-3 text-slate-900 dark:text-white">Certificates &amp;
                            Revenue</h4>
                        <p class="text-sm text-slate-600 dark:text-slate-400 leading-relaxed font-medium">
                            Online application for birth/death certificates, property tax payments, income certificates,
                            and land revenue services.
                        </p>
                    </div>
                </div>
                <div
                    class="mt-10 p-8 bg-emerald-950 text-white rounded-[2rem] flex flex-col md:flex-row items-center justify-between overflow-hidden relative border border-emerald-800 shadow-2xl">
                    <div class="relative z-10 mb-6 md:mb-0">
                        <div class="flex items-center gap-3 mb-2">
                            <div
                                class="size-10 rounded-full bg-emerald-500/20 border border-emerald-500/50 flex items-center justify-center">
                                <span class="material-symbols-outlined text-emerald-400">person</span>
                            </div>
                            <h4 class="font-black text-xl">Citizen Dashboard</h4>
                        </div>
                        <p class="text-emerald-200/70 text-sm font-medium">Login to track <span
                                class="text-emerald-300 underline font-bold">your active applications</span> across all
                            local governance services.</p>
                    </div>
                    <button onclick="openAuthModal('login')"
                        class="relative z-10 bg-white text-emerald-900 px-8 py-3 rounded-xl font-black text-sm shadow-xl hover:bg-emerald-50 transition-colors">
                        Access Dashboard
                    </button>
                    <div
                        class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-emerald-800/20 to-transparent pointer-events-none">
                    </div>
                </div>
            </div>
            <aside class="lg:col-span-4">
                <div
                    class="bg-emerald-50 dark:bg-emerald-900/10 border-2 border-emerald-100 dark:border-emerald-900/30 rounded-[2rem] p-8 sticky top-28 shadow-sm">
                    <div class="flex items-center gap-3 mb-8">
                        <div class="p-2 bg-accent/10 rounded-lg">
                            <span class="material-symbols-outlined text-accent text-3xl">campaign</span>
                        </div>
                        <div>
                            <h3 class="text-xl font-black text-slate-900 dark:text-white leading-none">Local Updates
                            </h3>
                            <p class="text-[10px] font-bold uppercase tracking-widest text-emerald-700/60 mt-1">Portal
                                Announcements</p>
                        </div>
                    </div>
                    <div class="space-y-8">
                        <div class="relative pl-8 border-l-2 border-accent">
                            <span
                                class="text-[10px] font-black text-accent uppercase tracking-[0.2em] block mb-2">Notice
                                •
                                Service Update</span>
                            <h5 class="text-sm font-extrabold mb-1 text-slate-900 dark:text-white">Digital Signatures
                                Enabled</h5>
                            <p class="text-xs text-slate-600 dark:text-slate-400 font-medium leading-relaxed">All
                                certificates can now be digitally signed for faster processing across the portal.</p>
                        </div>
                        <div class="relative pl-8 border-l-2 border-emerald-200 dark:border-emerald-800">
                            <span
                                class="text-[10px] font-black text-emerald-600 uppercase tracking-[0.2em] block mb-2">Schemes
                                • Active</span>
                            <h5 class="text-sm font-extrabold mb-1 text-slate-900 dark:text-white">Annual Subsidy
                                Program</h5>
                            <p class="text-xs text-slate-600 dark:text-slate-400 font-medium leading-relaxed">
                                Applications for the National Rural Livelihood schemes are now being accepted online.
                            </p>
                        </div>
                        <div class="relative pl-8 border-l-2 border-emerald-200 dark:border-emerald-800">
                            <span
                                class="text-[10px] font-black text-emerald-600 uppercase tracking-[0.2em] block mb-2">System
                                • News</span>
                            <h5 class="text-sm font-extrabold mb-1 text-slate-900 dark:text-white">Property Tax
                                Integration</h5>
                            <p class="text-xs text-slate-600 dark:text-slate-400 font-medium leading-relaxed">Unified
                                property tax assessment is now available for all mapped local bodies.</p>
                        </div>
                    </div>
                    <button onclick="window.location.href='index.html'"
                        class="w-full mt-10 bg-white dark:bg-slate-800 border-2 border-emerald-100 dark:border-emerald-700 py-4 rounded-xl text-xs font-black text-emerald-800 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition-all uppercase tracking-widest">
                        View All Notices
                    </button>
                </div>
                <div class="mt-6 p-6 bg-emerald-900 rounded-[2rem] text-white">
                    <div class="flex items-center gap-3 mb-4">
                        <span class="material-symbols-outlined text-emerald-400">gavel</span>
                        <h6 class="font-bold text-sm">Right to Service</h6>
                    </div>
                    <p class="text-xs text-emerald-100/70 mb-4 font-medium">Standard processing times apply to all
                        digital services as per the National e-Governance standards.</p>
                    <a class="text-xs font-black border-b border-emerald-500 pb-0.5 hover:text-emerald-300"
                        href="#">Citizen Charter</a>
                </div>
            </aside>
        </div>
    </main>
    <!-- Chatbot Floating Action Button & Window -->
    <div class="fixed bottom-10 right-10 z-[100] group">
        <!-- Chat Window -->
        <div id="chat-window"
            class="absolute bottom-full right-0 mb-6 transition-all duration-300 origin-bottom-right transform scale-0 opacity-0">
            <div
                class="bg-white dark:bg-slate-900 border-2 border-emerald-100 dark:border-emerald-800 shadow-2xl rounded-3xl w-80 sm:w-96 flex flex-col overflow-hidden max-h-[500px] h-[500px]">

                <!-- Chat Header -->
                <div class="bg-emerald-900 p-4 flex items-center justify-between shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="relative">
                            <span
                                class="size-2 bg-green-400 rounded-full absolute bottom-0 right-0 border border-emerald-900"></span>
                            <div class="size-8 rounded-full bg-emerald-700 flex items-center justify-center text-white">
                                <span class="material-symbols-outlined text-lg">smart_toy</span>
                            </div>
                        </div>
                        <div>
                            <p class="text-sm font-black text-white leading-none">Governance Sahayi</p>
                            <p class="text-[10px] text-emerald-300 font-medium mt-0.5">AI Assistant • Online</p>
                        </div>
                    </div>
                    <button onclick="toggleChat()" class="text-emerald-300 hover:text-white transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>

                <!-- Chat Messages Area -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50 dark:bg-[#0B1215]">
                    <!-- Welcome Message -->
                    <div class="flex gap-3">
                        <div
                            class="size-8 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex-shrink-0 flex items-center justify-center text-primary dark:text-emerald-400">
                            <span class="material-symbols-outlined text-sm">smart_toy</span>
                        </div>
                        <div
                            class="bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-3 rounded-2xl rounded-tl-none shadow-sm text-xs text-slate-600 dark:text-slate-300 font-medium leading-relaxed max-w-[85%]">
                            Hello! I am your AI assistant. Ask me about welfare schemes, certificates, or local
                            services.
                        </div>
                    </div>
                    <div class="space-y-2 mt-2 px-1">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 ml-1">Suggested:
                        </p>
                        <button onclick="sendSuggestion('How do I apply for a Welfare Scheme?')"
                            class="w-full text-left text-[10px] font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 px-3 py-2 rounded-xl hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:text-primary dark:hover:text-emerald-400 transition-colors">
                            Apply for Welfare Scheme
                        </button>
                        <button onclick="sendSuggestion('What is the Property Tax process?')"
                            class="w-full text-left text-[10px] font-bold bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 px-3 py-2 rounded-xl hover:bg-emerald-50 dark:hover:bg-emerald-900/20 hover:text-primary dark:hover:text-emerald-400 transition-colors">
                            Pay Property Tax
                        </button>
                    </div>
                </div>

                <!-- Chat Input Area -->
                <div class="p-3 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 shrink-0">
                    <form id="chat-form" class="flex items-end gap-2" onsubmit="handleChatSubmit(event)">
                        <input id="chat-input" type="text" placeholder="Type your query..."
                            class="w-full bg-slate-50 dark:bg-slate-800 border-none rounded-xl px-4 py-3 text-xs font-bold text-slate-800 dark:text-slate-200 outline-none focus:ring-1 focus:ring-emerald-500 placeholder:text-slate-400"
                            autocomplete="off">
                        <button type="submit"
                            class="bg-primary text-white p-3 rounded-xl hover:bg-emerald-700 transition-colors flex shadow-lg shadow-emerald-900/10">
                            <span class="material-symbols-outlined text-lg">send</span>
                        </button>
                    </form>
                    <p class="text-[9px] text-center text-slate-400 mt-2 font-medium">Powered by DeepSeek AI</p>
                </div>
            </div>
        </div>

        <!-- Toggle Button -->
        <button onclick="toggleChat()" id="chat-toggle-btn"
            class="size-16 bg-primary text-white rounded-full shadow-[0_10px_30px_rgba(6,95,70,0.3)] flex items-center justify-center hover:scale-105 transition-transform hover:shadow-emerald-900/30 active:scale-95 relative z-10">
            <span class="material-symbols-outlined text-3xl">chat_bubble</span>
        </button>
    </div>

    <script>
        function toggleChat() {
            const window = document.getElementById('chat-window');
            const btn = document.getElementById('chat-toggle-btn');

            if (window.classList.contains('scale-0')) {
                window.classList.remove('scale-0', 'opacity-0');
                btn.querySelector('span').innerText = 'expand_more';
                setTimeout(() => document.getElementById('chat-input').focus(), 300);
            } else {
                window.classList.add('scale-0', 'opacity-0');
                btn.querySelector('span').innerText = 'chat_bubble';
            }
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            const container = document.getElementById('chat-messages');

            if (!message) return;

            // Add User Message
            addMessage(message, 'user');
            input.value = '';

            // Add Loading Indicator
            const loadingId = addLoading();
            container.scrollTop = container.scrollHeight;

            try {
                const response = await API.chat(message);
                removeMessage(loadingId);
                if (response.reply) {
                    addMessage(response.reply, 'bot');
                } else {
                    addMessage("Sorry, I couldn't understand that.", 'bot');
                }
            } catch (err) {
                removeMessage(loadingId);
                console.error(err);
                addMessage("Service is currently unavailable. Please try again.", 'bot');
            }
        }

        function addMessage(text, sender) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'flex gap-3 ' + (sender === 'user' ? 'flex-row-reverse' : '');

            const avatar = sender === 'bot'
                ? `<div class="size-8 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex-shrink-0 flex items-center justify-center text-primary dark:text-emerald-400"><span class="material-symbols-outlined text-sm">smart_toy</span></div>`
                : `<div class="size-8 rounded-full bg-slate-100 dark:bg-slate-800 flex-shrink-0 flex items-center justify-center text-slate-500"><span class="material-symbols-outlined text-sm">person</span></div>`;

            const bubble = `<div class="${sender === 'bot' ? 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 text-slate-600 dark:text-slate-300' : 'bg-primary text-white border-primary'} border p-3 rounded-2xl ${sender === 'bot' ? 'rounded-tl-none' : 'rounded-tr-none'} shadow-sm text-xs font-medium leading-relaxed max-w-[85%]">${marked.parse(text)}</div>`; // Using marked for markdown if available, else text

            div.innerHTML = avatar + bubble;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex gap-3';
            div.innerHTML = `
                <div class="size-8 rounded-full bg-emerald-100 dark:bg-emerald-900/50 flex-shrink-0 flex items-center justify-center text-primary dark:text-emerald-400"><span class="material-symbols-outlined text-sm">smart_toy</span></div>
                <div class="bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 p-4 rounded-2xl rounded-tl-none shadow-sm flex gap-1 items-center">
                    <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce"></span>
                    <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-100"></span>
                    <span class="w-1.5 h-1.5 bg-slate-400 rounded-full animate-bounce delay-200"></span>
                </div>
            `;
            container.appendChild(div);
            return id;
        }

        function removeMessage(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        function sendSuggestion(text) {
            const input = document.getElementById('chat-input');
            input.value = text;
            handleChatSubmit({ preventDefault: () => { } });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <footer class="bg-slate-900 text-white py-16 mt-20">
        <div class="max-w-[1280px] mx-auto px-6 grid grid-cols-1 md:grid-cols-4 gap-12">
            <div class="md:col-span-1">
                <div class="flex items-center gap-3 mb-6">
                    <div class="bg-emerald-600 p-2 rounded-xl text-white">
                        <span class="material-symbols-outlined text-2xl">account_balance</span>
                    </div>
                    <span class="text-xl font-black">e-Panchayat</span>
                </div>
                <p class="text-sm text-slate-400 leading-relaxed font-medium">
                    The national digital governance portal providing a unified interface for local bodies. Promoting
                    transparency and ease of service for every citizen.
                </p>
            </div>
            <div>
                <h6 class="font-black mb-6 uppercase text-xs tracking-widest text-emerald-500">Navigation</h6>
                <ul class="space-y-3 text-sm font-medium">
                    <li><a class="text-slate-400 hover:text-white transition-colors" href="#">Welfare Schemes</a></li>
                    <li><a class="text-slate-400 hover:text-white transition-colors" href="#">Public Notices</a></li>
                    <li><a class="text-slate-400 hover:text-white transition-colors" href="#">Service Status</a></li>
                    <li><a class="text-slate-400 hover:text-white transition-colors" href="#">Tenders &amp; Projects</a>
                    </li>
                </ul>
            </div>
            <div>
                <h6 class="font-black mb-6 uppercase text-xs tracking-widest text-emerald-500">Direct Links</h6>
                <ul class="space-y-3 text-sm font-medium">
                    <li><a class="text-slate-400 hover:text-white transition-colors" href="#">Governance Portal</a></li>
                    <li><a class="text-slate-400 hover:text-white transition-colors" href="#">Support Desk</a></li>
                    <li><a class="text-slate-400 hover:text-white transition-colors" href="#">RTI Services</a></li>
                    <li><a class="text-slate-400 hover:text-white transition-colors" href="#">Grievance Redressal</a>
                    </li>
                </ul>
            </div>
            <div>
                <h6 class="font-black mb-6 uppercase text-xs tracking-widest text-accent">National Helpline</h6>
                <div class="bg-emerald-800/20 p-6 rounded-2xl border border-emerald-800/50">
                    <p class="text-[10px] font-black text-emerald-400 mb-2 uppercase tracking-widest">Portal Support</p>
                    <p class="text-xl font-black text-white">1800 123 4567</p>
                    <div class="mt-4 pt-4 border-t border-emerald-800/50">
                        <p class="text-[10px] font-black text-emerald-400 mb-2 uppercase tracking-widest">Emergency
                            Services</p>
                        <p class="text-lg font-black text-white">112 / 108</p>
                    </div>
                </div>
            </div>
        </div>
        <div
            class="max-w-[1280px] mx-auto px-6 mt-16 pt-8 border-t border-slate-800 flex flex-col md:flex-row justify-between items-center gap-6 text-xs text-slate-500 font-bold uppercase tracking-widest">
            <p>© 2024 e-Panchayat National Governance Portal. Unified for Citizens.</p>
            <div class="flex gap-8">
                <a class="hover:text-emerald-400" href="#">Privacy Policy</a>
                <a class="hover:text-emerald-400" href="#">Terms of Service</a>
                <a class="hover:text-emerald-400" href="#">Accessibility</a>
            </div>
        </div>
    </footer>

    <!-- AUTH MODALS CONTAINER -->
    <div id="auth-modal"
        class="fixed inset-0 z-[200] hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">

        <!-- Login Card -->
        <div id="login-card"
            class="bg-white dark:bg-slate-900 w-full max-w-md rounded-3xl p-8 relative shadow-2xl border border-emerald-100 dark:border-emerald-800 hidden">
            <button onclick="closeAuthModal()"
                class="absolute top-6 right-6 text-slate-400 hover:text-primary transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
            <div class="mb-8">
                <div class="inline-flex items-center gap-2 mb-4">
                    <span class="material-symbols-outlined text-3xl text-primary">account_balance</span>
                    <span
                        class="text-lg font-black tracking-tight text-primary dark:text-emerald-400">e-Panchayat</span>
                </div>
                <h3 class="text-2xl font-black text-slate-900 dark:text-white">Welcome Back</h3>
                <p class="text-sm text-slate-500 font-medium mt-1">Access your citizen dashboard securely.</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2"
                        for="login-email">Email Address</label>
                    <input
                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-bold text-slate-900 dark:text-white outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                        id="login-email" required type="email" placeholder="citizen@example.com" />
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-black text-slate-500 uppercase tracking-widest"
                            for="login-password">Password</label>
                        <a href="#" class="text-xs font-bold text-primary hover:underline">Forgot?</a>
                    </div>
                    <input
                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-bold text-slate-900 dark:text-white outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                        id="login-password" required type="password" placeholder="••••••••••••" />
                </div>
                <button type="submit"
                    class="w-full bg-primary text-white font-bold py-3.5 rounded-xl hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-900/10 flex items-center justify-center gap-2">
                    Login securely <span class="material-symbols-outlined text-lg">lock</span>
                </button>
            </form>

            <div class="mt-8 text-center pt-6 border-t border-slate-100 dark:border-slate-800">
                <p class="text-xs font-medium text-slate-500">Not registered yet?</p>
                <button onclick="switchModal('register')"
                    class="text-sm font-black text-primary hover:underline mt-1">Create new citizen account</button>
            </div>
        </div>

        <!-- Register Card -->
        <div id="register-card"
            class="bg-white dark:bg-slate-900 w-full max-w-md rounded-3xl p-8 relative shadow-2xl border border-emerald-100 dark:border-emerald-800 hidden">
            <button onclick="closeAuthModal()"
                class="absolute top-6 right-6 text-slate-400 hover:text-primary transition-colors">
                <span class="material-symbols-outlined">close</span>
            </button>
            <div class="mb-6">
                <h3 class="text-2xl font-black text-slate-900 dark:text-white">Citizen Registration</h3>
                <p class="text-sm text-slate-500 font-medium mt-1">Join the digital governance platform.</p>
            </div>

            <form id="register-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2"
                        for="reg-name">Full Name</label>
                    <input
                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-bold text-slate-900 dark:text-white outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                        id="reg-name" required type="text" placeholder="Ex: Rajesh Kumar" />
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2"
                        for="reg-email">Email Address</label>
                    <input
                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-bold text-slate-900 dark:text-white outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                        id="reg-email" required type="email" placeholder="citizen@example.com" />
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2"
                        for="reg-role">Role</label>
                    <select id="reg-role"
                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-bold text-slate-900 dark:text-white outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all appearance-none">
                        <option value="citizen">Citizen</option>
                        <option value="official">Official (Demo)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-2"
                        for="reg-password">Create Password</label>
                    <input
                        class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm font-bold text-slate-900 dark:text-white outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
                        id="reg-password" required type="password" placeholder="••••••••••••" />
                </div>
                <button type="submit"
                    class="w-full bg-primary text-white font-bold py-3.5 rounded-xl hover:bg-emerald-700 transition-all shadow-lg shadow-emerald-900/10 flex items-center justify-center gap-2">
                    Create Account <span class="material-symbols-outlined text-lg">person_add</span>
                </button>
            </form>

            <div class="mt-6 text-center pt-4 border-t border-slate-100 dark:border-slate-800">
                <p class="text-xs font-medium text-slate-500">Already have an account?</p>
                <button onclick="switchModal('login')"
                    class="text-sm font-black text-primary hover:underline mt-1">Login to Portal</button>
            </div>
        </div>
    </div>

    <!-- API Logic -->
    <script src="js/app.js"></script>
    <script>
        const modalOverlay = document.getElementById('auth-modal');
        const loginCard = document.getElementById('login-card');
        const registerCard = document.getElementById('register-card');

        function openAuthModal(type) {
            modalOverlay.classList.remove('hidden');
            if (type === 'login') {
                loginCard.classList.remove('hidden');
                registerCard.classList.add('hidden');
            } else {
                loginCard.classList.add('hidden');
                registerCard.classList.remove('hidden');
            }
        }

        function closeAuthModal() {
            modalOverlay.classList.add('hidden');
        }

        function switchModal(type) {
            if (type === 'login') {
                registerCard.classList.add('hidden');
                loginCard.classList.remove('hidden');
            } else {
                loginCard.classList.add('hidden');
                registerCard.classList.remove('hidden');
            }
        }


        // --- HEADER USER STATE ---
        let NAV_USER = null;

        async function checkAuthState() {
            const token = localStorage.getItem('token');
            if (!token) {
                showGuestNav();
                return;
            }

            try {
                const user = await API.getMe();
                NAV_USER = user;
                showUserNav(user);
            } catch (err) {
                console.error("Auth Check Failed:", err);
                // If invalid token, clear it
                localStorage.removeItem('token');
                showGuestNav();
            }
        }

        function showGuestNav() {
            const guest = document.getElementById('guest-nav');
            const user = document.getElementById('user-nav');
            if (guest) guest.classList.remove('hidden');
            if (user) {
                user.classList.add('hidden');
                user.classList.remove('flex');
            }
        }

        function showUserNav(user) {
            const guest = document.getElementById('guest-nav');
            const userNav = document.getElementById('user-nav');

            if (guest) guest.classList.add('hidden');
            if (userNav) {
                userNav.classList.remove('hidden');
                userNav.classList.add('flex');
            }

            // Update UI
            if (document.getElementById('nav-user-name'))
                document.getElementById('nav-user-name').innerText = user.full_name;
            if (document.getElementById('nav-user-role'))
                document.getElementById('nav-user-role').innerText = user.role.toUpperCase();

            const initial = user.full_name ? user.full_name.charAt(0).toUpperCase() : 'U';
            if (document.getElementById('nav-user-avatar'))
                document.getElementById('nav-user-avatar').innerText = initial;
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profile-dropdown');
            if (menu) menu.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('profile-dropdown');
            const trigger = document.getElementById('user-nav');
            if (menu && trigger && !menu.classList.contains('hidden') && !trigger.contains(e.target)) {
                menu.classList.add('hidden');
            }
        });

        function goToDashboard() {
            if (NAV_USER && (NAV_USER.role === 'admin' || NAV_USER.role === 'official')) {
                window.location.href = 'dashboard_admin.html';
            } else {
                window.location.href = 'dashboard_citizen.html';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        // Run on load
        checkAuthState();

        // --- AUTH LOGIC (Copied and Adapted) ---
        const loginForm = document.getElementById('login-form');
        const regForm = document.getElementById('register-form');

        loginForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = loginForm.querySelector('button[type="submit"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'Authenticating...';
            btn.disabled = true;

            try {
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                const data = await API.login(email, pass);
                if (data.access_token) {
                    localStorage.setItem('token', data.access_token);
                    const payload = JSON.parse(atob(data.access_token.split('.')[1]));

                    if (payload.role === 'admin' || payload.role === 'official') {
                        window.location.href = 'dashboard_admin.html';
                    } else {
                        window.location.href = 'dashboard_citizen.html';
                    }
                }
            } catch (err) {
                console.error(err);
                alert("Login Failed: " + (err.detail || "Check credentials"));
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        regForm.onsubmit = async (e) => {
            e.preventDefault();
            const btn = regForm.querySelector('button[type="submit"]');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = 'Creating...';
            btn.disabled = true;

            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const role = document.getElementById('reg-role').value;

            const data = {
                full_name: name,
                email: email,
                password: password,
                role: role
            };
            try {
                await API.register(data);
                alert("Account created successfully! Please login.");
                switchModal('login');
            } catch (err) {
                console.error(err);
                alert("Registration Failed: " + (err.detail || "Check console"));
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        };

        // --- VOICE GREETING ---
        function welcomeUser() {
            // Uncomment to force testing every time
            // sessionStorage.removeItem('greeted');

            if (sessionStorage.getItem('greeted')) {
                console.log("User already greeted this session.");
                return;
            }

            const now = new Date();
            const hour = now.getHours();
            let greeting = "Good morning";
            if (hour >= 12 && hour < 17) greeting = "Good afternoon";
            else if (hour >= 17) greeting = "Good evening";

            const assistantName = "Governance Sahayi";
            const message = `${greeting}. I am ${assistantName}, your digital assistant. Welcome to e-Kanthalloor. This application helps you access government schemes and services.`;

            const speak = () => {
                if (!window.speechSynthesis) return;

                // Cancel existing
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(message);

                // Wait for voices
                let voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        voices = window.speechSynthesis.getVoices();
                        playUtterance(utterance, voices);
                    };
                } else {
                    playUtterance(utterance, voices);
                }
            };

            const playUtterance = (utterance, voices) => {
                const preferredVoice = voices.find(v => v.lang.includes('en-IN')) || voices.find(v => v.lang.includes('en'));
                if (preferredVoice) utterance.voice = preferredVoice;

                utterance.rate = 0.9;
                utterance.onstart = () => {
                    console.log("Voice started playing");
                    sessionStorage.setItem('greeted', 'true');
                };
                utterance.onerror = (e) => {
                    console.error("Voice Error:", e);
                    // If not-allowed, it means autoplay blocked.
                    // We register a one-time click handler on the body
                    if (e.error === 'not-allowed' || e.error === 'interrupted') {
                        document.body.addEventListener('click', () => {
                            window.speechSynthesis.speak(utterance);
                        }, { once: true });
                    }
                };

                // Try speaking
                try {
                    window.speechSynthesis.speak(utterance);
                } catch (err) {
                    console.error("Speak catch:", err);
                }
            };

            // Initial Attempt
            speak();
        }

        // Run Logic
        if ('speechSynthesis' in window) {
            // Delay slightly to allow browser interaction flags to settle
            setTimeout(welcomeUser, 1500);
        }
    </script>
</body>

</html>